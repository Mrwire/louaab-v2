name: Deploy to Production

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v3
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¥ Install dependencies
      run: npm ci
      
    - name: ğŸ—ï¸ Build Next.js application
      run: npm run build
      
    - name: ğŸ“¦ Create deployment archive
      run: |
        tar -czf deployment.tar.gz .next package.json package-lock.json
        
    - name: ğŸ“¤ Deploy to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "deployment.tar.gz"
        target: "/tmp/"
        
    - name: ğŸš€ Extract and restart application
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /var/www/louaab
          rm -rf .next
          tar -xzf /tmp/deployment.tar.gz -C /var/www/louaab
          rm /tmp/deployment.tar.gz
          pm2 restart all
          
    - name: âœ… Deployment complete
      run: echo "ğŸ‰ Deployment to https://louaab.ma completed successfully!"
